<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>المدينة الحية: محاكي الإدارة</title>
    <style>
        :root {
            --color-bg: #f8f8f8;
            --color-primary: #007bff;
            --color-success: #28a745;
            --color-warning: #ffc107;
            --color-danger: #dc3545;
            --color-card-bg: #ffffff;
            --color-text: #333;
            --color-border: #eee;
            --font-family: 'Tahoma', 'Arial', sans-serif;
        }

        body {
            font-family: var(--font-family);
            background-color: var(--color-bg);
            color: var(--color-text);
            margin: 0;
            padding: 10px;
            text-align: right;
            line-height: 1.6;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .card {
            background-color: var(--color-card-bg);
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            border: 1px solid var(--color-border);
        }

        h1 {
            text-align: center;
            color: var(--color-primary);
            margin-top: 0;
            font-size: 1.8em;
            padding-bottom: 5px;
            border-bottom: 2px solid var(--color-primary);
        }

        /* Stats Box */
        #stats-box {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            font-size: 1.1em;
        }

        .stat-item {
            padding: 10px;
            border-radius: 8px;
            background-color: #f1f7fe;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .stat-value {
            font-weight: bold;
            color: var(--color-primary);
        }

        /* City Speak & Notifications */
        #city-speak {
            text-align: center;
            font-size: 1.2em;
            font-weight: bold;
            color: var(--color-success);
            padding: 10px;
            background-color: #e6ffe6;
            border-radius: 10px;
            border: 1px solid var(--color-success);
        }

        #notification {
            text-align: center;
            font-size: 1em;
            color: #fff;
            background-color: var(--color-primary);
            padding: 5px;
            border-radius: 8px;
            margin-bottom: 10px;
            display: none; /* Hidden by default */
        }
        
        /* Event Box */
        #event-title {
            font-weight: bold;
            font-size: 1.3em;
            margin-bottom: 10px;
            color: var(--color-text);
        }

        #progress-bar {
            height: 10px;
            background-color: var(--color-border);
            border-radius: 5px;
            margin-top: 10px;
            overflow: hidden;
        }

        #progress-fill {
            height: 100%;
            width: 0%;
            background-color: var(--color-success);
            transition: width 0.5s ease-in-out;
        }

        #stage-info {
            font-size: 0.9em;
            margin-top: 5px;
            color: #666;
        }

        /* Decisions/Choices Box */
        #decision-box {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .decision-button {
            background-color: var(--color-primary);
            color: white;
            border: none;
            padding: 15px 20px;
            text-align: center;
            text-decoration: none;
            display: block;
            font-size: 1.2em;
            margin-top: 5px;
            cursor: pointer;
            border-radius: 10px;
            transition: background-color 0.2s;
            touch-action: manipulation; /* Mobile performance */
        }

        .decision-button:hover, .decision-button:focus {
            background-color: #0056b3;
            outline: none;
        }
        
        .disabled-button {
            background-color: #ccc !important;
            cursor: default !important;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>المدينة الحية</h1>
        
        <div id="city-speak" class="card">المدينة تتنفس...</div>
        
        <div id="stats-card" class="card">
            <div id="stats-box">
                </div>
            <div id="stage-info"></div>
            <div id="progress-bar"><div id="progress-fill"></div></div>
        </div>

        <div id="notification"></div>
        
        <div id="event-card" class="card">
            <div id="event-title">لا يوجد أحداث حالياً...</div>
            <div id="decision-box">
                <button class="decision-button disabled-button" disabled>انتظر الحدث القادم</button>
            </div>
        </div>

    </div>

    <script>
        // #1. CITY_DATA: البيانات الثابتة
        const CITY_DATA = {
            stats: {
                population: 120, // 👥
                happiness: 68, // 😀
                health: 62, // ❤️
                economy: 55, // 💰
            },
            
            thresholds: [
                { name: "قرية", pop_req: 100, eco_req: 50 },
                { name: "بلدة", pop_req: 800, eco_req: 200 },
                { name: "مدينة", pop_req: 3000, eco_req: 500 },
                { name: "عاصمة", pop_req: 12000, eco_req: 1000 },
                { name: "حضارة", pop_req: 50000, eco_req: 2500 },
                { name: "إمبراطورية", pop_req: 100000, eco_req: 5000 }
            ],

            events: [
                // Common Events (rarity: 1)
                { id: 'FESTIVAL', title: "مهرجان الموسيقى السنوي", rarity: 1, choices: [
                    { text: "ادعم المهرجان", effect: { happiness: 10, economy: 5, population: 10 }, feedback: "جلب السعادة والزوار!" },
                    { text: "تجاهل", effect: { happiness: -3 }, feedback: "فُرصة ضائعة." }
                ]},
                { id: 'SANDSTORM', title: "عاصفة رملية مفاجئة", rarity: 1, choices: [
                    { text: "جهّز الملاجئ", effect: { health: 5, economy: -10 }, feedback: "حميت السكان لكن بتكلفة." },
                    { text: "انتظر انقشاعها", effect: { health: -15, economy: -5 }, feedback: "ضرر كبير على الصحة والتجارة!" }
                ]},
                { id: 'INVEST_GREEN', title: "مستثمر يطرح مشروعًا نظيفًا", rarity: 1, choices: [
                    { text: "ابنِ مصنعاً نظيفاً (Eco+)", effect: { economy: 20, health: 5, happiness: -5, population: 20 }, feedback: "اقتصاد مزدهر وبيئة سليمة." },
                    { text: "ارفض العرض", effect: { economy: 5 }, feedback: "فضلنا الحذر." }
                ]},
                { id: 'INVEST_POLLUTION', title: "مستثمر يطرح مشروعاً سريع الربح", rarity: 1, choices: [
                    { text: "ابنِ مصنعاً ملوثاً (Eco++)", effect: { economy: 35, health: -15, happiness: -10, population: 30 }, feedback: "ثراء سريع لكن على حساب البيئة!" },
                    { text: "ارفض العرض", effect: { economy: 5 }, feedback: "حماية البيئة أولاً." }
                ]},
                { id: 'NEW_TECH', title: "اكتشاف تقني جديد", rarity: 1, choices: [
                    { text: "ادعم البحث العلمي", effect: { economy: 15, happiness: 5, population: 15 }, feedback: "تحسّن في كل القطاعات." },
                    { text: "خفض ميزانية الأبحاث", effect: { economy: 5, happiness: -5 }, feedback: "لم نتمكن من الاستفادة الكاملة." }
                ]},
                // Rare Events (rarity: 5)
                { id: 'TREASURE', title: "اكتشاف كنز مدفون قديم! 💎", rarity: 5, choices: [
                    { text: "احصل على الكنز", effect: { economy: 100, happiness: 20 }, feedback: "ثروة هائلة للمدينة!" },
                    { text: "اعرضه في متحف", effect: { economy: 20, happiness: 40 }, feedback: "جذب سياحي وسعادة عظيمة." }
                ]},
                { id: 'TECH_REVOLUTION', title: "ثورة تكنولوجية! 🚀", rarity: 5, choices: [
                    { text: "تبنّى التكنولوجيا", effect: { population: 50, economy: 50, health: 25, happiness: 25 }, feedback: "نقلة نوعية للمدينة!" },
                    { text: "انتظر", effect: { economy: 10 }, feedback: "لم نغتنم الفرصة بالكامل." }
                ]},
                // Crisis Events (Only if health < 30 or happiness < 30)
                { id: 'PLAGUE', title: "وباء ينتشر في المدينة! 🦠", rarity: 0.5, condition: (stats) => stats.health < 30, choices: [
                    { text: "ابنِ مستشفى ميداني", effect: { health: 30, economy: -25 }, feedback: "سيطرنا على الوباء بتكلفة عالية." },
                    { text: "تجاهل الأزمة", effect: { health: -50, population: -100, happiness: -20 }, feedback: "خسائر فادحة!" }
                ]},
                { id: 'REVOLT', title: "احتجاجات واسعة النطاق! 😡", rarity: 0.5, condition: (stats) => stats.happiness < 30, choices: [
                    { text: "قدم تنازلات", effect: { happiness: 35, economy: -15 }, feedback: "الهدوء عاد، لكن الخزينة تأثرت." },
                    { text: "قمع الاحتجاجات", effect: { happiness: -10, health: -10 }, feedback: "الأوضاع تزداد سوءاً!" }
                ]}
            ],
        };

        // #2. حالة اللعبة العالمية
        let gameState = {
            stats: { ...CITY_DATA.stats },
            currentStageIndex: 0,
            lastPlayed: Date.now(),
            currentEvent: null,
        };

        const STAT_LABELS = {
            population: "👥 السكان",
            happiness: "😀 السعادة",
            health: "❤️ الصحة",
            economy: "💰 الاقتصاد",
        };

        const GAME_LOOP_INTERVAL = 30000; // 30 ثانية لكل دورة لعب
        
        // #3. الدوال الأساسية

        /** تهيئة اللعبة وتحميل الحالة */
        function init() {
            try {
                loadState();
                applyOfflineGrowth();
            } catch (e) {
                console.error("Failed to load state or apply growth, starting fresh.", e);
            }
            renderStats();
            citySpeak();
            
            // بدء حلقة اللعبة
            setInterval(gameLoop, GAME_LOOP_INTERVAL);
            
            // تشغيل الدورة الأولى فورًا
            gameLoop();
        }

        /** دورة اللعب الأساسية */
        function gameLoop() {
            if (gameState.currentEvent) return; // لا تبدأ حدث جديد وهناك قرار معلق

            checkStageUnlock();
            pickEvent();
            saveState(); // حفظ بعد كل دورة
        }

        /** تحميل حالة اللعبة من localStorage */
        function loadState() {
            const savedState = localStorage.getItem('city_alive_state');
            if (savedState) {
                const loaded = JSON.parse(savedState);
                // دمج الحالة المحملة مع الابتدائية لضمان عدم فقدان مفاتيح
                gameState.stats = { ...CITY_DATA.stats, ...loaded.stats };
                gameState.currentStageIndex = loaded.currentStageIndex || 0;
                gameState.lastPlayed = loaded.lastPlayed || Date.now();
                showNotification("تم استعادة حالة المدينة. مرحباً بعودتك!");
            } else {
                showNotification("بدأت مدينة جديدة! مرحباً بك أيها الحاكم.");
            }
        }

        /** حفظ حالة اللعبة إلى localStorage */
        function saveState() {
            localStorage.setItem('city_alive_state', JSON.stringify({
                stats: gameState.stats,
                currentStageIndex: gameState.currentStageIndex,
                lastPlayed: Date.now(),
            }));
        }

        /** تطبيق نمو بسيط عند العودة بعد فترة غياب (Offline Growth) */
        function applyOfflineGrowth() {
            const now = Date.now();
            const timeDiff = now - gameState.lastPlayed;
            
            // تجاهل النمو إذا كان الفارق أقل من 15 دقيقة
            if (timeDiff < 900000) return; 

            const cyclesMissed = Math.floor(timeDiff / GAME_LOOP_INTERVAL);
            const maxCycles = 50; // حد أقصى للنمو لـ 25 دقيقة (لتجنب القيم المبالغ فيها)
            const actualCycles = Math.min(cyclesMissed, maxCycles);
            
            if (actualCycles > 0) {
                // نمو أساسي بسيط
                const growthFactor = actualCycles * 0.05; // نمو بطيء
                gameState.stats.population += Math.floor(gameState.stats.population * growthFactor);
                gameState.stats.economy += Math.floor(gameState.stats.economy * growthFactor);
                // تذبذب الصحة والسعادة (ممكن أن تزيد أو تنقص حسب الحظ)
                gameState.stats.health += Math.floor(Math.random() * 10 * actualCycles - 5 * actualCycles);
                gameState.stats.happiness += Math.floor(Math.random() * 10 * actualCycles - 5 * actualCycles);
                
                showNotification(`تم تطبيق نمو زمني ${actualCycles} دورة غياب.`);
            }
        }

        /** عرض الإحصائيات في الواجهة */
        function renderStats() {
            const statsBox = document.getElementById('stats-box');
            statsBox.innerHTML = ''; // مسح الإحصائيات القديمة
            
            // التأكد من أن القيم لا تنزل عن الصفر
            Object.keys(gameState.stats).forEach(key => {
                gameState.stats[key] = Math.max(0, gameState.stats[key]);
                // حدود عليا (اختياري، لكن يضمن تذبذباً منطقياً)
                if (['happiness', 'health'].includes(key)) {
                    gameState.stats[key] = Math.min(150, gameState.stats[key]);
                }
            });

            // عرض كل إحصائية
            for (const key in gameState.stats) {
                const statDiv = document.createElement('div');
                statDiv.className = 'stat-item';
                statDiv.innerHTML = `<span>${STAT_LABELS[key]}</span><span class="stat-value">${Math.floor(gameState.stats[key])}</span>`;
                statsBox.appendChild(statDiv);
            }
            
            renderProgress();
        }
        
        /** عرض شريط التقدم نحو المرحلة التالية */
        function renderProgress() {
            const currentStage = CITY_DATA.thresholds[gameState.currentStageIndex];
            const nextStage = CITY_DATA.thresholds[gameState.currentStageIndex + 1];
            const stageInfo = document.getElementById('stage-info');
            const progressFill = document.getElementById('progress-fill');

            if (!nextStage) {
                stageInfo.textContent = `🥳 وصلت المدينة إلى أقصى المراحل: ${currentStage.name}!`;
                progressFill.style.width = '100%';
                progressFill.style.backgroundColor = '#ffcc00';
                return;
            }

            stageInfo.textContent = `مرحلة ${currentStage.name} | التقدم نحو: ${nextStage.name} (سكان: ${gameState.stats.population}/${nextStage.pop_req}, اقتصاد: ${gameState.stats.economy}/${nextStage.eco_req})`;
            
            // حساب التقدم باستخدام السكان والاقتصاد
            const popProgress = Math.min(gameState.stats.population / nextStage.pop_req, 1);
            const ecoProgress = Math.min(gameState.stats.economy / nextStage.eco_req, 1);
            const overallProgress = (popProgress + ecoProgress) / 2 * 100;
            
            progressFill.style.width = `${overallProgress}%`;
            progressFill.style.backgroundColor = overallProgress >= 100 ? var(--color-warning) : var(--color-success);
        }

        /** اختيار وعرض حدث جديد */
        function pickEvent() {
            const allEvents = CITY_DATA.events;
            let eventPool = [];

            // تجميع الأحداث العادية
            eventPool.push(...allEvents.filter(e => e.rarity === 1));

            // إضافة الأحداث النادرة بفرصة 5%
            if (Math.random() < 0.05) {
                eventPool.push(...allEvents.filter(e => e.rarity === 5));
            }
            
            // إضافة أحداث الأزمات إذا كانت الشروط مطبقة
            const crisisEvents = allEvents.filter(e => e.condition && e.condition(gameState.stats));
            if (crisisEvents.length > 0 && Math.random() < 0.3) {
                eventPool.push(...crisisEvents);
            }

            if (eventPool.length === 0) {
                eventPool = allEvents.filter(e => e.rarity === 1); // fallback
            }

            // اختيار حدث عشوائي من المجمع
            const eventIndex = Math.floor(Math.random() * eventPool.length);
            const selectedEvent = eventPool[eventIndex];
            
            if (!selectedEvent) return; // لا يوجد حدث

            gameState.currentEvent = selectedEvent;
            
            const eventTitleEl = document.getElementById('event-title');
            const decisionBoxEl = document.getElementById('decision-box');

            eventTitleEl.textContent = selectedEvent.title;
            decisionBoxEl.innerHTML = ''; // مسح القرارات القديمة

            selectedEvent.choices.forEach((choice, index) => {
                const button = document.createElement('button');
                button.className = 'decision-button';
                button.textContent = choice.text;
                button.onclick = () => applyEffect(selectedEvent, index);
                decisionBoxEl.appendChild(button);
            });
            
            // رسالة تنبيه للمستخدم
            showNotification(`⚠️ حدث جديد يتطلب قرارك!`);
        }

        /** تطبيق تأثير القرار على الإحصائيات */
        function applyEffect(event, choiceIndex) {
            const choice = event.choices[choiceIndex];
            const effect = choice.effect;

            // تطبيق التأثيرات
            for (const key in effect) {
                gameState.stats[key] += effect[key];
            }
            
            // إظهار التغذية الراجعة
            showNotification(`✅ قرارك: ${choice.text}. ${choice.feedback}`, 5000);
            
            // إعادة تعيين الحدث
            gameState.currentEvent = null;
            document.getElementById('event-title').textContent = "لا يوجد أحداث حالياً...";
            document.getElementById('decision-box').innerHTML = '<button class="decision-button disabled-button" disabled>انتظر الحدث القادم</button>';
            
            // تحديث الواجهة وحفظ الحالة
            renderStats();
            checkStageUnlock();
            citySpeak();
            saveState();
        }

        /** التحقق من عتبات فتح المرحلة الجديدة */
        function checkStageUnlock() {
            const currentStageIndex = gameState.currentStageIndex;
            const nextStage = CITY_DATA.thresholds[currentStageIndex + 1];

            if (!nextStage) return; // لا توجد مراحل أخرى

            if (gameState.stats.population >= nextStage.pop_req && gameState.stats.economy >= nextStage.eco_req) {
                gameState.currentStageIndex++;
                const newStage = CITY_DATA.thresholds[gameState.currentStageIndex];
                
                // مكافأة فتح المرحلة
                gameState.stats.population += 50;
                gameState.stats.happiness += 20;
                gameState.stats.health += 20;
                gameState.stats.economy += 50;
                
                showNotification(`🎉 تهانينا! تمت ترقية المدينة إلى: ${newStage.name}!`, 10000);
                renderStats();
                citySpeak();
                saveState();
            }
        }

        /** تحديث رسالة "كلام المدينة" */
        function citySpeak() {
            const speakBox = document.getElementById('city-speak');
            let message = "المدينة تتنفس ببطء...";

            if (gameState.stats.health < 30) {
                message = "المدينة مريضة! ❤️ يجب التدخل فوراً.";
            } else if (gameState.stats.happiness < 30) {
                message = "المدينة غاضبة! 😡 الاحتجاجات وشيكة.";
            } else if (gameState.stats.economy > 1000 && gameState.stats.health > 80 && gameState.stats.happiness > 80) {
                message = "ازدهار ورخاء! 🌟 المدينة في أوج مجدها.";
            } else if (gameState.stats.population > 5000) {
                message = "توسع حضري! 🏙️ المدينة تكبر وتتطلب المزيد.";
            } else if (gameState.stats.health > 70 && gameState.stats.happiness > 70) {
                message = "استقرار جيد. ✨ الوضع تحت السيطرة.";
            }
            
            speakBox.textContent = `${CITY_DATA.thresholds[gameState.currentStageIndex].name} | ${message}`;
        }
        
        /** عرض إشعارات نصية قصيرة */
        function showNotification(text, duration = 3000) {
            const notificationEl = document.getElementById('notification');
            notificationEl.textContent = text;
            notificationEl.style.display = 'block';
            
            clearTimeout(notificationEl.timer);
            notificationEl.timer = setTimeout(() => {
                notificationEl.style.display = 'none';
            }, duration);
        }

        // #4. تشغيل اللعبة
        init();
    </script>
</body>
</html>

