<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© Ø§Ù„Ø­ÙŠØ©: Ù…Ø­Ø§ÙƒÙŠ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</title>
    <style>
        :root {
            --color-bg: #f8f8f8;
            --color-primary: #007bff;
            --color-success: #28a745;
            --color-warning: #ffc107;
            --color-danger: #dc3545;
            --color-card-bg: #ffffff;
            --color-text: #333;
            --color-border: #eee;
            --font-family: 'Tahoma', 'Arial', sans-serif;
        }

        body {
            font-family: var(--font-family);
            background-color: var(--color-bg);
            color: var(--color-text);
            margin: 0;
            padding: 10px;
            text-align: right;
            line-height: 1.6;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .card {
            background-color: var(--color-card-bg);
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            border: 1px solid var(--color-border);
        }

        h1 {
            text-align: center;
            color: var(--color-primary);
            margin-top: 0;
            font-size: 1.8em;
            padding-bottom: 5px;
            border-bottom: 2px solid var(--color-primary);
        }

        /* Stats Box */
        #stats-box {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            font-size: 1.1em;
        }

        .stat-item {
            padding: 10px;
            border-radius: 8px;
            background-color: #f1f7fe;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .stat-value {
            font-weight: bold;
            color: var(--color-primary);
        }

        /* City Speak & Notifications */
        #city-speak {
            text-align: center;
            font-size: 1.2em;
            font-weight: bold;
            color: var(--color-success);
            padding: 10px;
            background-color: #e6ffe6;
            border-radius: 10px;
            border: 1px solid var(--color-success);
        }

        #notification {
            text-align: center;
            font-size: 1em;
            color: #fff;
            background-color: var(--color-primary);
            padding: 5px;
            border-radius: 8px;
            margin-bottom: 10px;
            display: none; /* Hidden by default */
        }
        
        /* Event Box */
        #event-title {
            font-weight: bold;
            font-size: 1.3em;
            margin-bottom: 10px;
            color: var(--color-text);
        }

        #progress-bar {
            height: 10px;
            background-color: var(--color-border);
            border-radius: 5px;
            margin-top: 10px;
            overflow: hidden;
        }

        #progress-fill {
            height: 100%;
            width: 0%;
            background-color: var(--color-success);
            transition: width 0.5s ease-in-out;
        }

        #stage-info {
            font-size: 0.9em;
            margin-top: 5px;
            color: #666;
        }

        /* Decisions/Choices Box */
        #decision-box {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .decision-button {
            background-color: var(--color-primary);
            color: white;
            border: none;
            padding: 15px 20px;
            text-align: center;
            text-decoration: none;
            display: block;
            font-size: 1.2em;
            margin-top: 5px;
            cursor: pointer;
            border-radius: 10px;
            transition: background-color 0.2s;
            touch-action: manipulation; /* Mobile performance */
        }

        .decision-button:hover, .decision-button:focus {
            background-color: #0056b3;
            outline: none;
        }
        
        .disabled-button {
            background-color: #ccc !important;
            cursor: default !important;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© Ø§Ù„Ø­ÙŠØ©</h1>
        
        <div id="city-speak" class="card">Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© ØªØªÙ†ÙØ³...</div>
        
        <div id="stats-card" class="card">
            <div id="stats-box">
                </div>
            <div id="stage-info"></div>
            <div id="progress-bar"><div id="progress-fill"></div></div>
        </div>

        <div id="notification"></div>
        
        <div id="event-card" class="card">
            <div id="event-title">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£Ø­Ø¯Ø§Ø« Ø­Ø§Ù„ÙŠØ§Ù‹...</div>
            <div id="decision-box">
                <button class="decision-button disabled-button" disabled>Ø§Ù†ØªØ¸Ø± Ø§Ù„Ø­Ø¯Ø« Ø§Ù„Ù‚Ø§Ø¯Ù…</button>
            </div>
        </div>

    </div>

    <script>
        // #1. CITY_DATA: Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø«Ø§Ø¨ØªØ©
        const CITY_DATA = {
            stats: {
                population: 120, // ğŸ‘¥
                happiness: 68, // ğŸ˜€
                health: 62, // â¤ï¸
                economy: 55, // ğŸ’°
            },
            
            thresholds: [
                { name: "Ù‚Ø±ÙŠØ©", pop_req: 100, eco_req: 50 },
                { name: "Ø¨Ù„Ø¯Ø©", pop_req: 800, eco_req: 200 },
                { name: "Ù…Ø¯ÙŠÙ†Ø©", pop_req: 3000, eco_req: 500 },
                { name: "Ø¹Ø§ØµÙ…Ø©", pop_req: 12000, eco_req: 1000 },
                { name: "Ø­Ø¶Ø§Ø±Ø©", pop_req: 50000, eco_req: 2500 },
                { name: "Ø¥Ù…Ø¨Ø±Ø§Ø·ÙˆØ±ÙŠØ©", pop_req: 100000, eco_req: 5000 }
            ],

            events: [
                // Common Events (rarity: 1)
                { id: 'FESTIVAL', title: "Ù…Ù‡Ø±Ø¬Ø§Ù† Ø§Ù„Ù…ÙˆØ³ÙŠÙ‚Ù‰ Ø§Ù„Ø³Ù†ÙˆÙŠ", rarity: 1, choices: [
                    { text: "Ø§Ø¯Ø¹Ù… Ø§Ù„Ù…Ù‡Ø±Ø¬Ø§Ù†", effect: { happiness: 10, economy: 5, population: 10 }, feedback: "Ø¬Ù„Ø¨ Ø§Ù„Ø³Ø¹Ø§Ø¯Ø© ÙˆØ§Ù„Ø²ÙˆØ§Ø±!" },
                    { text: "ØªØ¬Ø§Ù‡Ù„", effect: { happiness: -3 }, feedback: "ÙÙØ±ØµØ© Ø¶Ø§Ø¦Ø¹Ø©." }
                ]},
                { id: 'SANDSTORM', title: "Ø¹Ø§ØµÙØ© Ø±Ù…Ù„ÙŠØ© Ù…ÙØ§Ø¬Ø¦Ø©", rarity: 1, choices: [
                    { text: "Ø¬Ù‡Ù‘Ø² Ø§Ù„Ù…Ù„Ø§Ø¬Ø¦", effect: { health: 5, economy: -10 }, feedback: "Ø­Ù…ÙŠØª Ø§Ù„Ø³ÙƒØ§Ù† Ù„ÙƒÙ† Ø¨ØªÙƒÙ„ÙØ©." },
                    { text: "Ø§Ù†ØªØ¸Ø± Ø§Ù†Ù‚Ø´Ø§Ø¹Ù‡Ø§", effect: { health: -15, economy: -5 }, feedback: "Ø¶Ø±Ø± ÙƒØ¨ÙŠØ± Ø¹Ù„Ù‰ Ø§Ù„ØµØ­Ø© ÙˆØ§Ù„ØªØ¬Ø§Ø±Ø©!" }
                ]},
                { id: 'INVEST_GREEN', title: "Ù…Ø³ØªØ«Ù…Ø± ÙŠØ·Ø±Ø­ Ù…Ø´Ø±ÙˆØ¹Ù‹Ø§ Ù†Ø¸ÙŠÙÙ‹Ø§", rarity: 1, choices: [
                    { text: "Ø§Ø¨Ù†Ù Ù…ØµÙ†Ø¹Ø§Ù‹ Ù†Ø¸ÙŠÙØ§Ù‹ (Eco+)", effect: { economy: 20, health: 5, happiness: -5, population: 20 }, feedback: "Ø§Ù‚ØªØµØ§Ø¯ Ù…Ø²Ø¯Ù‡Ø± ÙˆØ¨ÙŠØ¦Ø© Ø³Ù„ÙŠÙ…Ø©." },
                    { text: "Ø§Ø±ÙØ¶ Ø§Ù„Ø¹Ø±Ø¶", effect: { economy: 5 }, feedback: "ÙØ¶Ù„Ù†Ø§ Ø§Ù„Ø­Ø°Ø±." }
                ]},
                { id: 'INVEST_POLLUTION', title: "Ù…Ø³ØªØ«Ù…Ø± ÙŠØ·Ø±Ø­ Ù…Ø´Ø±ÙˆØ¹Ø§Ù‹ Ø³Ø±ÙŠØ¹ Ø§Ù„Ø±Ø¨Ø­", rarity: 1, choices: [
                    { text: "Ø§Ø¨Ù†Ù Ù…ØµÙ†Ø¹Ø§Ù‹ Ù…Ù„ÙˆØ«Ø§Ù‹ (Eco++)", effect: { economy: 35, health: -15, happiness: -10, population: 30 }, feedback: "Ø«Ø±Ø§Ø¡ Ø³Ø±ÙŠØ¹ Ù„ÙƒÙ† Ø¹Ù„Ù‰ Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¨ÙŠØ¦Ø©!" },
                    { text: "Ø§Ø±ÙØ¶ Ø§Ù„Ø¹Ø±Ø¶", effect: { economy: 5 }, feedback: "Ø­Ù…Ø§ÙŠØ© Ø§Ù„Ø¨ÙŠØ¦Ø© Ø£ÙˆÙ„Ø§Ù‹." }
                ]},
                { id: 'NEW_TECH', title: "Ø§ÙƒØªØ´Ø§Ù ØªÙ‚Ù†ÙŠ Ø¬Ø¯ÙŠØ¯", rarity: 1, choices: [
                    { text: "Ø§Ø¯Ø¹Ù… Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø¹Ù„Ù…ÙŠ", effect: { economy: 15, happiness: 5, population: 15 }, feedback: "ØªØ­Ø³Ù‘Ù† ÙÙŠ ÙƒÙ„ Ø§Ù„Ù‚Ø·Ø§Ø¹Ø§Øª." },
                    { text: "Ø®ÙØ¶ Ù…ÙŠØ²Ø§Ù†ÙŠØ© Ø§Ù„Ø£Ø¨Ø­Ø§Ø«", effect: { economy: 5, happiness: -5 }, feedback: "Ù„Ù… Ù†ØªÙ…ÙƒÙ† Ù…Ù† Ø§Ù„Ø§Ø³ØªÙØ§Ø¯Ø© Ø§Ù„ÙƒØ§Ù…Ù„Ø©." }
                ]},
                // Rare Events (rarity: 5)
                { id: 'TREASURE', title: "Ø§ÙƒØªØ´Ø§Ù ÙƒÙ†Ø² Ù…Ø¯ÙÙˆÙ† Ù‚Ø¯ÙŠÙ…! ğŸ’", rarity: 5, choices: [
                    { text: "Ø§Ø­ØµÙ„ Ø¹Ù„Ù‰ Ø§Ù„ÙƒÙ†Ø²", effect: { economy: 100, happiness: 20 }, feedback: "Ø«Ø±ÙˆØ© Ù‡Ø§Ø¦Ù„Ø© Ù„Ù„Ù…Ø¯ÙŠÙ†Ø©!" },
                    { text: "Ø§Ø¹Ø±Ø¶Ù‡ ÙÙŠ Ù…ØªØ­Ù", effect: { economy: 20, happiness: 40 }, feedback: "Ø¬Ø°Ø¨ Ø³ÙŠØ§Ø­ÙŠ ÙˆØ³Ø¹Ø§Ø¯Ø© Ø¹Ø¸ÙŠÙ…Ø©." }
                ]},
                { id: 'TECH_REVOLUTION', title: "Ø«ÙˆØ±Ø© ØªÙƒÙ†ÙˆÙ„ÙˆØ¬ÙŠØ©! ğŸš€", rarity: 5, choices: [
                    { text: "ØªØ¨Ù†Ù‘Ù‰ Ø§Ù„ØªÙƒÙ†ÙˆÙ„ÙˆØ¬ÙŠØ§", effect: { population: 50, economy: 50, health: 25, happiness: 25 }, feedback: "Ù†Ù‚Ù„Ø© Ù†ÙˆØ¹ÙŠØ© Ù„Ù„Ù…Ø¯ÙŠÙ†Ø©!" },
                    { text: "Ø§Ù†ØªØ¸Ø±", effect: { economy: 10 }, feedback: "Ù„Ù… Ù†ØºØªÙ†Ù… Ø§Ù„ÙØ±ØµØ© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„." }
                ]},
                // Crisis Events (Only if health < 30 or happiness < 30)
                { id: 'PLAGUE', title: "ÙˆØ¨Ø§Ø¡ ÙŠÙ†ØªØ´Ø± ÙÙŠ Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©! ğŸ¦ ", rarity: 0.5, condition: (stats) => stats.health < 30, choices: [
                    { text: "Ø§Ø¨Ù†Ù Ù…Ø³ØªØ´ÙÙ‰ Ù…ÙŠØ¯Ø§Ù†ÙŠ", effect: { health: 30, economy: -25 }, feedback: "Ø³ÙŠØ·Ø±Ù†Ø§ Ø¹Ù„Ù‰ Ø§Ù„ÙˆØ¨Ø§Ø¡ Ø¨ØªÙƒÙ„ÙØ© Ø¹Ø§Ù„ÙŠØ©." },
                    { text: "ØªØ¬Ø§Ù‡Ù„ Ø§Ù„Ø£Ø²Ù…Ø©", effect: { health: -50, population: -100, happiness: -20 }, feedback: "Ø®Ø³Ø§Ø¦Ø± ÙØ§Ø¯Ø­Ø©!" }
                ]},
                { id: 'REVOLT', title: "Ø§Ø­ØªØ¬Ø§Ø¬Ø§Øª ÙˆØ§Ø³Ø¹Ø© Ø§Ù„Ù†Ø·Ø§Ù‚! ğŸ˜¡", rarity: 0.5, condition: (stats) => stats.happiness < 30, choices: [
                    { text: "Ù‚Ø¯Ù… ØªÙ†Ø§Ø²Ù„Ø§Øª", effect: { happiness: 35, economy: -15 }, feedback: "Ø§Ù„Ù‡Ø¯ÙˆØ¡ Ø¹Ø§Ø¯ØŒ Ù„ÙƒÙ† Ø§Ù„Ø®Ø²ÙŠÙ†Ø© ØªØ£Ø«Ø±Øª." },
                    { text: "Ù‚Ù…Ø¹ Ø§Ù„Ø§Ø­ØªØ¬Ø§Ø¬Ø§Øª", effect: { happiness: -10, health: -10 }, feedback: "Ø§Ù„Ø£ÙˆØ¶Ø§Ø¹ ØªØ²Ø¯Ø§Ø¯ Ø³ÙˆØ¡Ø§Ù‹!" }
                ]}
            ],
        };

        // #2. Ø­Ø§Ù„Ø© Ø§Ù„Ù„Ø¹Ø¨Ø© Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠØ©
        let gameState = {
            stats: { ...CITY_DATA.stats },
            currentStageIndex: 0,
            lastPlayed: Date.now(),
            currentEvent: null,
        };

        const STAT_LABELS = {
            population: "ğŸ‘¥ Ø§Ù„Ø³ÙƒØ§Ù†",
            happiness: "ğŸ˜€ Ø§Ù„Ø³Ø¹Ø§Ø¯Ø©",
            health: "â¤ï¸ Ø§Ù„ØµØ­Ø©",
            economy: "ğŸ’° Ø§Ù„Ø§Ù‚ØªØµØ§Ø¯",
        };

        const GAME_LOOP_INTERVAL = 30000; // 30 Ø«Ø§Ù†ÙŠØ© Ù„ÙƒÙ„ Ø¯ÙˆØ±Ø© Ù„Ø¹Ø¨
        
        // #3. Ø§Ù„Ø¯ÙˆØ§Ù„ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©

        /** ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù„Ø¹Ø¨Ø© ÙˆØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø­Ø§Ù„Ø© */
        function init() {
            try {
                loadState();
                applyOfflineGrowth();
            } catch (e) {
                console.error("Failed to load state or apply growth, starting fresh.", e);
            }
            renderStats();
            citySpeak();
            
            // Ø¨Ø¯Ø¡ Ø­Ù„Ù‚Ø© Ø§Ù„Ù„Ø¹Ø¨Ø©
            setInterval(gameLoop, GAME_LOOP_INTERVAL);
            
            // ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¯ÙˆØ±Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰ ÙÙˆØ±Ù‹Ø§
            gameLoop();
        }

        /** Ø¯ÙˆØ±Ø© Ø§Ù„Ù„Ø¹Ø¨ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© */
        function gameLoop() {
            if (gameState.currentEvent) return; // Ù„Ø§ ØªØ¨Ø¯Ø£ Ø­Ø¯Ø« Ø¬Ø¯ÙŠØ¯ ÙˆÙ‡Ù†Ø§Ùƒ Ù‚Ø±Ø§Ø± Ù…Ø¹Ù„Ù‚

            checkStageUnlock();
            pickEvent();
            saveState(); // Ø­ÙØ¸ Ø¨Ø¹Ø¯ ÙƒÙ„ Ø¯ÙˆØ±Ø©
        }

        /** ØªØ­Ù…ÙŠÙ„ Ø­Ø§Ù„Ø© Ø§Ù„Ù„Ø¹Ø¨Ø© Ù…Ù† localStorage */
        function loadState() {
            const savedState = localStorage.getItem('city_alive_state');
            if (savedState) {
                const loaded = JSON.parse(savedState);
                // Ø¯Ù…Ø¬ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø­Ù…Ù„Ø© Ù…Ø¹ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠØ© Ù„Ø¶Ù…Ø§Ù† Ø¹Ø¯Ù… ÙÙ‚Ø¯Ø§Ù† Ù…ÙØ§ØªÙŠØ­
                gameState.stats = { ...CITY_DATA.stats, ...loaded.stats };
                gameState.currentStageIndex = loaded.currentStageIndex || 0;
                gameState.lastPlayed = loaded.lastPlayed || Date.now();
                showNotification("ØªÙ… Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©. Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ø¹ÙˆØ¯ØªÙƒ!");
            } else {
                showNotification("Ø¨Ø¯Ø£Øª Ù…Ø¯ÙŠÙ†Ø© Ø¬Ø¯ÙŠØ¯Ø©! Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ Ø£ÙŠÙ‡Ø§ Ø§Ù„Ø­Ø§ÙƒÙ….");
            }
        }

        /** Ø­ÙØ¸ Ø­Ø§Ù„Ø© Ø§Ù„Ù„Ø¹Ø¨Ø© Ø¥Ù„Ù‰ localStorage */
        function saveState() {
            localStorage.setItem('city_alive_state', JSON.stringify({
                stats: gameState.stats,
                currentStageIndex: gameState.currentStageIndex,
                lastPlayed: Date.now(),
            }));
        }

        /** ØªØ·Ø¨ÙŠÙ‚ Ù†Ù…Ùˆ Ø¨Ø³ÙŠØ· Ø¹Ù†Ø¯ Ø§Ù„Ø¹ÙˆØ¯Ø© Ø¨Ø¹Ø¯ ÙØªØ±Ø© ØºÙŠØ§Ø¨ (Offline Growth) */
        function applyOfflineGrowth() {
            const now = Date.now();
            const timeDiff = now - gameState.lastPlayed;
            
            // ØªØ¬Ø§Ù‡Ù„ Ø§Ù„Ù†Ù…Ùˆ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„ÙØ§Ø±Ù‚ Ø£Ù‚Ù„ Ù…Ù† 15 Ø¯Ù‚ÙŠÙ‚Ø©
            if (timeDiff < 900000) return; 

            const cyclesMissed = Math.floor(timeDiff / GAME_LOOP_INTERVAL);
            const maxCycles = 50; // Ø­Ø¯ Ø£Ù‚ØµÙ‰ Ù„Ù„Ù†Ù…Ùˆ Ù„Ù€ 25 Ø¯Ù‚ÙŠÙ‚Ø© (Ù„ØªØ¬Ù†Ø¨ Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ù…Ø¨Ø§Ù„Øº ÙÙŠÙ‡Ø§)
            const actualCycles = Math.min(cyclesMissed, maxCycles);
            
            if (actualCycles > 0) {
                // Ù†Ù…Ùˆ Ø£Ø³Ø§Ø³ÙŠ Ø¨Ø³ÙŠØ·
                const growthFactor = actualCycles * 0.05; // Ù†Ù…Ùˆ Ø¨Ø·ÙŠØ¡
                gameState.stats.population += Math.floor(gameState.stats.population * growthFactor);
                gameState.stats.economy += Math.floor(gameState.stats.economy * growthFactor);
                // ØªØ°Ø¨Ø°Ø¨ Ø§Ù„ØµØ­Ø© ÙˆØ§Ù„Ø³Ø¹Ø§Ø¯Ø© (Ù…Ù…ÙƒÙ† Ø£Ù† ØªØ²ÙŠØ¯ Ø£Ùˆ ØªÙ†Ù‚Øµ Ø­Ø³Ø¨ Ø§Ù„Ø­Ø¸)
                gameState.stats.health += Math.floor(Math.random() * 10 * actualCycles - 5 * actualCycles);
                gameState.stats.happiness += Math.floor(Math.random() * 10 * actualCycles - 5 * actualCycles);
                
                showNotification(`ØªÙ… ØªØ·Ø¨ÙŠÙ‚ Ù†Ù…Ùˆ Ø²Ù…Ù†ÙŠ ${actualCycles} Ø¯ÙˆØ±Ø© ØºÙŠØ§Ø¨.`);
            }
        }

        /** Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ÙÙŠ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© */
        function renderStats() {
            const statsBox = document.getElementById('stats-box');
            statsBox.innerHTML = ''; // Ù…Ø³Ø­ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
            
            // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ù‚ÙŠÙ… Ù„Ø§ ØªÙ†Ø²Ù„ Ø¹Ù† Ø§Ù„ØµÙØ±
            Object.keys(gameState.stats).forEach(key => {
                gameState.stats[key] = Math.max(0, gameState.stats[key]);
                // Ø­Ø¯ÙˆØ¯ Ø¹Ù„ÙŠØ§ (Ø§Ø®ØªÙŠØ§Ø±ÙŠØŒ Ù„ÙƒÙ† ÙŠØ¶Ù…Ù† ØªØ°Ø¨Ø°Ø¨Ø§Ù‹ Ù…Ù†Ø·Ù‚ÙŠØ§Ù‹)
                if (['happiness', 'health'].includes(key)) {
                    gameState.stats[key] = Math.min(150, gameState.stats[key]);
                }
            });

            // Ø¹Ø±Ø¶ ÙƒÙ„ Ø¥Ø­ØµØ§Ø¦ÙŠØ©
            for (const key in gameState.stats) {
                const statDiv = document.createElement('div');
                statDiv.className = 'stat-item';
                statDiv.innerHTML = `<span>${STAT_LABELS[key]}</span><span class="stat-value">${Math.floor(gameState.stats[key])}</span>`;
                statsBox.appendChild(statDiv);
            }
            
            renderProgress();
        }
        
        /** Ø¹Ø±Ø¶ Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù… Ù†Ø­Ùˆ Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„ØªØ§Ù„ÙŠØ© */
        function renderProgress() {
            const currentStage = CITY_DATA.thresholds[gameState.currentStageIndex];
            const nextStage = CITY_DATA.thresholds[gameState.currentStageIndex + 1];
            const stageInfo = document.getElementById('stage-info');
            const progressFill = document.getElementById('progress-fill');

            if (!nextStage) {
                stageInfo.textContent = `ğŸ¥³ ÙˆØµÙ„Øª Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© Ø¥Ù„Ù‰ Ø£Ù‚ØµÙ‰ Ø§Ù„Ù…Ø±Ø§Ø­Ù„: ${currentStage.name}!`;
                progressFill.style.width = '100%';
                progressFill.style.backgroundColor = '#ffcc00';
                return;
            }

            stageInfo.textContent = `Ù…Ø±Ø­Ù„Ø© ${currentStage.name} | Ø§Ù„ØªÙ‚Ø¯Ù… Ù†Ø­Ùˆ: ${nextStage.name} (Ø³ÙƒØ§Ù†: ${gameState.stats.population}/${nextStage.pop_req}, Ø§Ù‚ØªØµØ§Ø¯: ${gameState.stats.economy}/${nextStage.eco_req})`;
            
            // Ø­Ø³Ø§Ø¨ Ø§Ù„ØªÙ‚Ø¯Ù… Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø³ÙƒØ§Ù† ÙˆØ§Ù„Ø§Ù‚ØªØµØ§Ø¯
            const popProgress = Math.min(gameState.stats.population / nextStage.pop_req, 1);
            const ecoProgress = Math.min(gameState.stats.economy / nextStage.eco_req, 1);
            const overallProgress = (popProgress + ecoProgress) / 2 * 100;
            
            progressFill.style.width = `${overallProgress}%`;
            progressFill.style.backgroundColor = overallProgress >= 100 ? var(--color-warning) : var(--color-success);
        }

        /** Ø§Ø®ØªÙŠØ§Ø± ÙˆØ¹Ø±Ø¶ Ø­Ø¯Ø« Ø¬Ø¯ÙŠØ¯ */
        function pickEvent() {
            const allEvents = CITY_DATA.events;
            let eventPool = [];

            // ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ø¹Ø§Ø¯ÙŠØ©
            eventPool.push(...allEvents.filter(e => e.rarity === 1));

            // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ù†Ø§Ø¯Ø±Ø© Ø¨ÙØ±ØµØ© 5%
            if (Math.random() < 0.05) {
                eventPool.push(...allEvents.filter(e => e.rarity === 5));
            }
            
            // Ø¥Ø¶Ø§ÙØ© Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ø£Ø²Ù…Ø§Øª Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø´Ø±ÙˆØ· Ù…Ø·Ø¨Ù‚Ø©
            const crisisEvents = allEvents.filter(e => e.condition && e.condition(gameState.stats));
            if (crisisEvents.length > 0 && Math.random() < 0.3) {
                eventPool.push(...crisisEvents);
            }

            if (eventPool.length === 0) {
                eventPool = allEvents.filter(e => e.rarity === 1); // fallback
            }

            // Ø§Ø®ØªÙŠØ§Ø± Ø­Ø¯Ø« Ø¹Ø´ÙˆØ§Ø¦ÙŠ Ù…Ù† Ø§Ù„Ù…Ø¬Ù…Ø¹
            const eventIndex = Math.floor(Math.random() * eventPool.length);
            const selectedEvent = eventPool[eventIndex];
            
            if (!selectedEvent) return; // Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø­Ø¯Ø«

            gameState.currentEvent = selectedEvent;
            
            const eventTitleEl = document.getElementById('event-title');
            const decisionBoxEl = document.getElementById('decision-box');

            eventTitleEl.textContent = selectedEvent.title;
            decisionBoxEl.innerHTML = ''; // Ù…Ø³Ø­ Ø§Ù„Ù‚Ø±Ø§Ø±Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©

            selectedEvent.choices.forEach((choice, index) => {
                const button = document.createElement('button');
                button.className = 'decision-button';
                button.textContent = choice.text;
                button.onclick = () => applyEffect(selectedEvent, index);
                decisionBoxEl.appendChild(button);
            });
            
            // Ø±Ø³Ø§Ù„Ø© ØªÙ†Ø¨ÙŠÙ‡ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
            showNotification(`âš ï¸ Ø­Ø¯Ø« Ø¬Ø¯ÙŠØ¯ ÙŠØªØ·Ù„Ø¨ Ù‚Ø±Ø§Ø±Ùƒ!`);
        }

        /** ØªØ·Ø¨ÙŠÙ‚ ØªØ£Ø«ÙŠØ± Ø§Ù„Ù‚Ø±Ø§Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª */
        function applyEffect(event, choiceIndex) {
            const choice = event.choices[choiceIndex];
            const effect = choice.effect;

            // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªØ£Ø«ÙŠØ±Ø§Øª
            for (const key in effect) {
                gameState.stats[key] += effect[key];
            }
            
            // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„ØªØºØ°ÙŠØ© Ø§Ù„Ø±Ø§Ø¬Ø¹Ø©
            showNotification(`âœ… Ù‚Ø±Ø§Ø±Ùƒ: ${choice.text}. ${choice.feedback}`, 5000);
            
            // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø­Ø¯Ø«
            gameState.currentEvent = null;
            document.getElementById('event-title').textContent = "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£Ø­Ø¯Ø§Ø« Ø­Ø§Ù„ÙŠØ§Ù‹...";
            document.getElementById('decision-box').innerHTML = '<button class="decision-button disabled-button" disabled>Ø§Ù†ØªØ¸Ø± Ø§Ù„Ø­Ø¯Ø« Ø§Ù„Ù‚Ø§Ø¯Ù…</button>';
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© ÙˆØ­ÙØ¸ Ø§Ù„Ø­Ø§Ù„Ø©
            renderStats();
            checkStageUnlock();
            citySpeak();
            saveState();
        }

        /** Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¹ØªØ¨Ø§Øª ÙØªØ­ Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© */
        function checkStageUnlock() {
            const currentStageIndex = gameState.currentStageIndex;
            const nextStage = CITY_DATA.thresholds[currentStageIndex + 1];

            if (!nextStage) return; // Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø±Ø§Ø­Ù„ Ø£Ø®Ø±Ù‰

            if (gameState.stats.population >= nextStage.pop_req && gameState.stats.economy >= nextStage.eco_req) {
                gameState.currentStageIndex++;
                const newStage = CITY_DATA.thresholds[gameState.currentStageIndex];
                
                // Ù…ÙƒØ§ÙØ£Ø© ÙØªØ­ Ø§Ù„Ù…Ø±Ø­Ù„Ø©
                gameState.stats.population += 50;
                gameState.stats.happiness += 20;
                gameState.stats.health += 20;
                gameState.stats.economy += 50;
                
                showNotification(`ğŸ‰ ØªÙ‡Ø§Ù†ÙŠÙ†Ø§! ØªÙ…Øª ØªØ±Ù‚ÙŠØ© Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© Ø¥Ù„Ù‰: ${newStage.name}!`, 10000);
                renderStats();
                citySpeak();
                saveState();
            }
        }

        /** ØªØ­Ø¯ÙŠØ« Ø±Ø³Ø§Ù„Ø© "ÙƒÙ„Ø§Ù… Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©" */
        function citySpeak() {
            const speakBox = document.getElementById('city-speak');
            let message = "Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© ØªØªÙ†ÙØ³ Ø¨Ø¨Ø·Ø¡...";

            if (gameState.stats.health < 30) {
                message = "Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© Ù…Ø±ÙŠØ¶Ø©! â¤ï¸ ÙŠØ¬Ø¨ Ø§Ù„ØªØ¯Ø®Ù„ ÙÙˆØ±Ø§Ù‹.";
            } else if (gameState.stats.happiness < 30) {
                message = "Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© ØºØ§Ø¶Ø¨Ø©! ğŸ˜¡ Ø§Ù„Ø§Ø­ØªØ¬Ø§Ø¬Ø§Øª ÙˆØ´ÙŠÙƒØ©.";
            } else if (gameState.stats.economy > 1000 && gameState.stats.health > 80 && gameState.stats.happiness > 80) {
                message = "Ø§Ø²Ø¯Ù‡Ø§Ø± ÙˆØ±Ø®Ø§Ø¡! ğŸŒŸ Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© ÙÙŠ Ø£ÙˆØ¬ Ù…Ø¬Ø¯Ù‡Ø§.";
            } else if (gameState.stats.population > 5000) {
                message = "ØªÙˆØ³Ø¹ Ø­Ø¶Ø±ÙŠ! ğŸ™ï¸ Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© ØªÙƒØ¨Ø± ÙˆØªØªØ·Ù„Ø¨ Ø§Ù„Ù…Ø²ÙŠØ¯.";
            } else if (gameState.stats.health > 70 && gameState.stats.happiness > 70) {
                message = "Ø§Ø³ØªÙ‚Ø±Ø§Ø± Ø¬ÙŠØ¯. âœ¨ Ø§Ù„ÙˆØ¶Ø¹ ØªØ­Øª Ø§Ù„Ø³ÙŠØ·Ø±Ø©.";
            }
            
            speakBox.textContent = `${CITY_DATA.thresholds[gameState.currentStageIndex].name} | ${message}`;
        }
        
        /** Ø¹Ø±Ø¶ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ù†ØµÙŠØ© Ù‚ØµÙŠØ±Ø© */
        function showNotification(text, duration = 3000) {
            const notificationEl = document.getElementById('notification');
            notificationEl.textContent = text;
            notificationEl.style.display = 'block';
            
            clearTimeout(notificationEl.timer);
            notificationEl.timer = setTimeout(() => {
                notificationEl.style.display = 'none';
            }, duration);
        }

        // #4. ØªØ´ØºÙŠÙ„ Ø§Ù„Ù„Ø¹Ø¨Ø©
        init();
    </script>
</body>
</html>

